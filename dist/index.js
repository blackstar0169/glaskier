var B=Object.create;var G=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var Q=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of K(e))!$.call(s,i)&&i!==t&&G(s,i,{get:()=>e[i],enumerable:!(n=J(e,i))||n.enumerable});return s};var c=(s,e,t)=>(t=s!=null?B(W(s)):{},Q(e||!s||!s.__esModule?G(t,"default",{value:s,enumerable:!0}):t,s));var U=c(require("fs")),f=require("discord.js");var b=require("discord.js"),M=c(require("moment"));var T=c(require("dotenv"));var g=require("@discordjs/voice");async function V(s){let e=(0,g.joinVoiceChannel)({channelId:s.id,guildId:s.guild.id,adapterCreator:s.guild.voiceAdapterCreator});try{return await(0,g.entersState)(e,g.VoiceConnectionStatus.Ready,3e3),e}catch(t){throw e.destroy(),t}}function N(s,e){let t=s;typeof s=="object"&&typeof s.id<"u"&&(t=s.id);for(let n=0;n<e.length;n++)if(t===e[n].guild.id)return e[n]}function D(s,e){return Math.floor(Math.random()*(e+1-s))+s}function j(s){return typeof s=="string"&&s===""?!0:typeof s>"u"||s===null||s===!1||s===0}function A(s,e){let t,n,i=[];for(t=0,n=s.length;t<n;t+=e)i.push(s.slice(t,t+e));return i}function S(s){return s.toLowerCase().replace(/(-|_)./g,e=>e[1].toUpperCase())}var O=class{constructor(){this.config={};this.default={lang:"en",soundDir:"./sounds"};this.required=["nodeEnv","discordToken","discordClientId"]}init(){T.default.config({debug:!0});let e=this.populate(process.env),t=this.validate(e);if(t.length>0)throw new Error("Config error. Missing properties : "+t.join(", "));this.config=Object.assign({},this.default,e)}populate(e){let t={};for(let n in e)if(Object.hasOwnProperty.call(e,n)){let i=S(n);t[i]=e[n]}return t}validate(e){let t=[];for(let n=0;n<this.required.length;n++)(typeof e[this.required[n]]>"u"||e[this.required[n]]===null||e[this.required[n]]==="")&&t.push(this.required[n]);return t}get(e,t=void 0){return typeof this.config[e]<"u"?this.config[e]:t}set(e,t){return this.config[e]=t}isProd(){let e=this.get("nodeEnv","dev");return e==="prod"||e==="production"}},a=new O;var E=require("discord.js"),w=require("@discordjs/voice"),F=c(require("mp3-duration")),H=c(require("moment"));var C=c(require("fs"));var{EventEmitter:X}=require("events"),m=class extends X{triggerError(e){e&&console.error(e),this.emit("error",this,e)}};var y=class extends m{constructor(e,t=null,n=0){if(super(),this.channel=t,this.timeoutDate=null,this.player=e,this.soundPath=null,t!==null)this.client=t.client;else if(t===null&&!j(e))this.client=e.guild.client;else return this.triggerError("Bad Target object construction. You must give a Channel or at lease a GuildPlayer object."),null;typeof n=="number"&&n>=0&&(this.timeoutDate=(0,H.default)().add(n,"seconds"),this.timeout=setTimeout(()=>{this.play()},n*1e3))}cancel(){clearTimeout(this.timeout),this.timeout=null,this.channel=null,this.timeoutDate=null}setSound(e){this.soundPath=e}play(){if(this.channel===null&&!j(this.player)){if(this.player.scanChannels(),this.player.availableChannels.size===0)return this.triggerError("Can't find non empty channel in Guild "+this.player.guild.name),!1;this.channel=this.player.availableChannels.random()}if(!this.isValid())return this.channel instanceof E.VoiceChannel?this.channel.speakable?this.channel.joinable?this.channel.members.size===0?this.triggerError("Aucun membre pr\xE9sent dans "+this.player.guild.name+"/"+this.channel.name):this.triggerError("Erreur ind\xE9termin\xE9e pour acc\xE8der \xE0 "+this.player.guild.name+"/"+this.channel.name):(console.trace("error"),this.triggerError("Le bot ne peut pas aller dans le channel "+this.player.guild.name+"/"+this.channel.name)):this.triggerError("Le bot ne peut pas parler dans le channel "+this.player.guild.name+"/"+this.channel.name):this.triggerError("Channel instance invalide pour "+this.player.guild.name+"/"+this.channel.name),!1;if(typeof this.soundPath!="string"||this.soundPath.length===0){let t=this.player.getSounds();if(t&&t.length===0)return this.triggerError("Dossier audio vide."),!1;let n=t&&t.length||0,i=D(0,n-1);this.soundPath=C.default.realpathSync(this.player.soundDir+t[i])}if(typeof this.soundPath!="string"||!C.default.existsSync(this.soundPath))return this.triggerError("Fichier audio inexistant : "+this.soundPath),!1;try{C.default.accessSync(this.soundPath,C.default.constants.R_OK)}catch(t){return console.log(t),this.triggerError("Acc\xE8s refus\xE9 au fichier audio : "+this.soundPath),!1}console.log("["+new Date().toISOString()+"] "+this.soundPath),(0,F.default)(this.soundPath,async(t,n)=>{if(t){console.error(t.message);return}n+=1;let i=(0,w.createAudioResource)(this.soundPath),r=(0,w.createAudioPlayer)(),o=null,l=null;r.play(i);try{o=await V(this.channel),l=o.subscribe(r)}catch(h){o&&o.destroy(),console.error(h);return}setTimeout(()=>{l&&l.unsubscribe(),o&&o.destroy(),this.emit("played",this.channel,this.soundPath),this.timeout=null,this.timeoutDate=null,this.channel=null},n*1e3)})}isValid(){return this.channel instanceof E.VoiceChannel&&this.channel.joinable&&this.channel.speakable&&this.channel.members.size>0}};var x=c(require("fs")),P=class{constructor(e){this.dir="./cache/";this.values={};this.file=e,x.default.existsSync(this.dir)||(console.error("Storage dir does not exists"),process.exit(3)),x.default.existsSync(this.dir+this.file)&&this.load()}all(){return this.values}pull(e,t=void 0){return Object.keys(this.values).indexOf(e)>=0?this.values[e]:t}push(e,t){this.values[e]=t,this.save()}forget(e){Object.keys(this.values).indexOf(e)>=0&&delete this.values[e],this.save()}flush(){this.values={},this.save()}save(){x.default.writeFileSync(this.dir+this.file,JSON.stringify(this.values))}load(){this.values=JSON.parse(x.default.readFileSync(this.dir+this.file).toString())}};var L=c(require("fs")),R=c(require("path"));var z=1,q=1,u=class extends m{constructor(t){super();this.target=null;this.history=[];this.target=null,this.started=!0,this.minLimit=a.get("defaultMinTime",600),this.maxLimit=a.get("defaultMaxTime",3600),this.history=[],this.guild=t,this.availableChannels=new b.Collection,this.cache=new P(this.guild.id),this.soundDir=a.get("soundDir").replace(/\/$/,""),this.soundDir=L.default.realpathSync(this.soundDir),this.soundDir.substr(-1)!=="/"&&(this.soundDir+="/"),this.planNextPlay(),this.guild.client.on("channelCreate",this.scanChannels.bind(this)),this.guild.client.on("channelDelete",this.scanChannels.bind(this)),this.guild.client.on("voiceStateUpdate",()=>{this.scanChannels.bind(this),this.target===null&&this.planNextPlay()})}planNextPlay(){return!this.started||(this.target!==null&&(this.target.cancel(),this.target=null),this.scanChannels(),this.availableChannels.size===0)?null:(this.target=new y(null,this,D(this.minLimit,this.maxLimit)),this.target.on("played",(t,n)=>{this.addHistory(t,n),this.planNextPlay()}),this.target.on("error",(t,n)=>{this.planNextPlay()}),this.target)}addHistory(t,n){for(this.history.push("["+(0,M.default)().format("DD/MM/YYYY HH:mm:ss")+"] Channel : "+t.name+" | Membres : "+t.members.filter(i=>i.id!==this.guild.members.me.id).map(i=>i.displayName).join(", ")+" | Son : "+R.default.basename(n));this.history.length>50;)this.history.shift()}scanChannels(){return this.availableChannels=this.guild.channels.cache.filter(t=>t instanceof b.VoiceChannel&&t.speakable&&t.members.size),this.availableChannels}destroy(){this.target!==null&&this.target.timeoutDate.isBefore((0,M.default)())&&this.target.cancel()}stop(){this.started&&(this.target!==null&&this.target.timeoutDate.isSameOrAfter((0,M.default)())&&this.target.cancel(),this.target=null,this.started=!1)}start(){return this.started?!0:(this.started=!0,this.planNextPlay())}targetMember(t,n){let i=this.guild.channels.cache.find(r=>r instanceof b.VoiceChannel&&r.members.find(o=>o.id===t.id));return typeof i!="object"?z:this.targetChannel(i,n)}targetChannel(t,n){if(t instanceof b.VoiceChannel&&t.joinable&&t.speakable&&t.members.size){let i=new y(t,this);return i.setSound(n),i.play(),i}else return q}getSounds(){return typeof this.soundDir!="string"?(this.triggerError("Dossier audio introuvable : "+a.get("soundDir")),!1):L.default.readdirSync(this.soundDir).filter(t=>t.match(/.*\.(mp3|wav)$/))}static get eCantFindMember(){return z}static get eChannelPermissions(){return q}};var k=require("discord.js");var p=class{static async exec(e,t){let n=S(e.options.getSubcommand()),i=e.options.data.options,r=this[n](t,e,i);try{await e.reply("Chargement...")}catch(o){console.log(o)}if(typeof r=="string"&&r.length>0)try{await e.editReply(r)}catch(o){console.log(o)}else if(typeof r=="object"&&Array.isArray(r)&&r.length>0)try{await e.editReply("R\xE9ponse incorrecte")}catch(o){console.log(o)}}static help(){let e=`This bot is playing random songs in a choosen channel in which there is users.
`+this.usage;for(let t in this.commands)Object.hasOwnProperty.call(this.commands,t)&&(e+="	**"+t+"** : "+this.commands[t]+`
`);return e}static test(e,t){let n=e.targetMember(t.member);return typeof n=="number"?n===u.eCantFindMember?"Impossible de trouver "+t.member.displayName:n===u.eChannelPermissions?"Permission insufisante pour entrer dans le channel.":"Code d'erreur : "+n:"Test :sweat_drops:"}static next(e){if(!e.started)return"Je ne suis pas d\xE9marrer. Pour le faire, lance la commande `!gla start`";if(e.target){let t="Ma prochaine intervention \xE0 "+e.target.timeoutDate.format("DD/MM/YYYY HH:mm:ss");return e.target.channel&&(t+=" dans le salon "+e.target.channel.name),t}return"Pas d'intervention de pr\xE9vue. Lancez la commande `!gla reroll` pour planifier al\xE9atoirement une intervention."}static reroll(e){if(e.planNextPlay(),e.target){let t="Ma prochaine intervention \xE0 "+e.target.timeoutDate.format("DD/MM/YYYY HH:mm:ss");return e.target.channel&&(t+=" dans le salon "+e.target.channel.name),t}return"Impossible de planifier une intervention. V\xE9rifie qu'il y a du monde dans au moins un channel"}static start(e){let t="";return e.started?t+="D\xE9j\xE0 d\xE9marr\xE9 !":(e.start(),t+="D\xE9marrage..."),e.target?t+=" Prochaine intervention \xE0 "+e.target.timeoutDate.format("DD/MM/YYYY HH:mm:ss")+" dans le salon "+e.target.channel.name:t+=" Aucune intervention planifi\xE9e.",t}static stop(e){return e.started?(e.stop(),"Stopp\xE9"):"D\xE9j\xE0 stopp\xE9 !"}static history(e){if(e.history.length===0)return"Aucune intervention depuis le lancement du serveur.";let t=A(e.history,10),n=["Les "+e.history.length+" derni\xE8res interventions : \n```\n"+t[0].join(`
`)+"\n```"];for(let i=1;i<t.length;i++)n.push("```\n"+t[i].join(`
`)+"\n```");return n.join(`
`)}static debug(e,t){let n=t.member.user.id,i=t.options.get("option");if(n.toString()!==a.get("creatorId"))return"Seul mon cr\xE9ateur peut acc\xE9der \xE0 cette commande.";if(i&&i.value){if(i.value==="play")return e.target.play(),"Forcing the next song to play.";if(i.value==="getUserId")return"Your user id is "+n}return"Wrong option"}static play(e,t){let n=e.getSounds().map(h=>h.replace(".mp3","")),i=t.options.get("key"),r=t.options.get("channel"),o;if(!i)return"Usage : /gla play [key]";if(i=i.value,n.indexOf(i)>=0)i=n.indexOf(i);else if(typeof n[i]>"u")return"Aucun son associ\xE9 \xE0 "+i+".";let l=e.soundDir+n[i]+".mp3";if(r){let h=0;r=r.value;let I=t.guild.channels.cache.find(Y=>{let _=Y instanceof k.VoiceChannel&&(Y.name===r||h===r);return h++,_});if(!I)return'Impossible de trouver le salon "'+r+'".';o=e.targetChannel(I,l)}else o=e.targetMember(t.member,l);return typeof o=="number"?o===u.eCantFindMember?"Impossible de trouver "+t.member.displayName:o===u.eChannelPermissions?"Permission insufisante pour entrer dans le channel.":"Code d'erreur : "+o:"Play :hot_face:"}static bind(e,t){let n=e.cache.pull("binds",{}),i=t.options.get("key"),r=t.options.get("sound"),o="",l=e.getSounds().map(h=>h.replace(".mp3",""));return!i||!r?"Usage : /gla bind [bind_name] [song_name/song_index]":(r=r.value,i=i.value,typeof l[r]!="string"&&l.indexOf(r)<0?'Impossible de trouver le son "'+r+'". Utiliser la commande `/gla listsongs` pour lister les sons disponnibles':(typeof n[i]=="string"?o='Le bind "'+i+'" a \xE9t\xE9 remplac\xE9 avec succ\xE8s':o='Le bind "'+i+'" a \xE9t\xE9 cr\xE9\xE9 avec succ\xE8s',typeof l[r]=="string"&&(r=l[r]),n[i]=r,e.cache.push("binds",n),o))}static unbind(e,t){let n=e.cache.pull("binds",{}),i=t.options.get("key"),r="";return i?(i=i.value,typeof n[i]=="string"?(delete n[i],r='Le bind "'+i+'" a \xE9t\xE9 supprim\xE9 avec succ\xE8s'):r='Le bind "'+i+`" n'existe pas`,e.cache.push("binds",n),r):"Usage : /gla unbind [bind_name]"}static listSounds(e,t){let n=`Liste des sons :
`,i=e.getSounds();if(i.length===0)return"Aucun son disponible.";for(let r in i)Object.hasOwnProperty.call(i,r)&&(n+=r+" : "+i[r].replace(".mp3","")+`
`);return n}static listBinds(e,t){let n=`Liste des binds :
`,i=e.cache.pull("binds",{});if(Object.keys(i).length===0)return"Aucun bind n'a \xE9t\xE9 cr\xE9\xE9.";for(let r in i)Object.hasOwnProperty.call(i,r)&&(n+=r+" : "+i[r]+`
`);return n}static listChannels(e,t){let n=`Liste des salons vocaux :
`,i=0;return t.guild.channels.cache.forEach(r=>{r instanceof k.VoiceChannel&&(n+=i+": "+r.name+`
`,i++)}),n}};p.commands={help:"List commands",stop:"Stop the bot to play random songs",start:"Start the bot to play random songs",next:"Display the date and in which channel the next song will be played",reroll:"Generate a new random time to play a song",test:"Play a song in your channel. Don't interupte the next random traget",history:"List the last 50 glitch",debug:"Debug command. Only available for the creator.",play:"[key] [channel?] Play a binded song if there is a key or a random song.",listsounds:"List songs."},p.usage=`Usage: !gla [command] [options]...
`;console.log("Running NodeJS "+process.version);console.log("CWD : "+process.cwd());var v=new f.Client({intents:[f.GatewayIntentBits.Guilds,f.GatewayIntentBits.GuildVoiceStates,f.GatewayIntentBits.GuildMessages,f.GatewayIntentBits.MessageContent]}),d=[];U.default.existsSync(".env")||(console.error("Env file "+process.cwd()+"/.env not found."),process.exit(1));try{a.init()}catch(s){console.error(".env file parsing error",s),process.exit(2)}process.on("SIGINT",function(){console.error("Process stopped")});v.on("ready",()=>{console.log("Servers list : "),v.guilds.cache.each(s=>{d.push(new u(s)),console.log(s.name)}),typeof process.send=="function"&&process.send("ready")});v.on("interactionCreate",async s=>{if(s.isChatInputCommand()&&s.commandName==="gla"){let e=s.member.user.id;if(!a.isProd()&&e!==a.get("creatorId"))s.channel.send(":warning: Je suis en maintenance.");else{let t=N(s.guild.id,d);p.exec(s,t)}}});v.on("guildCreate",s=>{console.log("Added to guild "+s.name),typeof d.filter(t=>s.id===t.guild.id)>"u"&&d.push(new u(s))});v.on("guildDelete",s=>{console.log("Removed from guild "+s.name);for(let e=d.length;e>=0;e--)s.id===d[e].guild.id&&(d[e].destroy(),delete d[e])});v.login(a.get("discordToken"));
